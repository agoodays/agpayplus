# 首次部署 vs 更新部署说明

## 🎯 重要区别

### 首次部署（First Deployment）

**定义**：系统中没有任何运行中的 AgPay+ 容器

**特点**：
- ✅ 没有旧服务
- ✅ 没有历史备份
- ✅ 失败时只需清理，无需回滚

**失败处理**：
```
构建失败 → 清理失败的资源 → 修复问题 → 重新部署
```

---

### 更新部署（Update Deployment）

**定义**：系统中已有运行中的 AgPay+ 容器，需要更新

**特点**：
- ✅ 有旧服务运行
- ✅ 有配置可备份
- ✅ 失败时需要回滚到旧版本

**失败处理**：
```
构建失败 → 自动回滚 → 恢复旧服务 → 系统继续可用
```

---

## 🔍 脚本自动识别

### 新版脚本（带回滚）

脚本会**自动检测**是首次部署还是更新部署：

#### 首次部署时

```powershell
[2/8] 跳过备份（首次部署）
[3/8] 配置环境变量...
[4/8] 配置 SSL 证书...
...

# 如果失败
[清理] 这是首次部署，清理失败的资源...
  ✓ 已清理失败的容器
  
  首次部署失败，请检查错误信息后重试
  提示：
    1. 检查 .env 配置是否正确
    2. 确保网络连接正常（参考 DOCKER_MIRROR_GUIDE.md）
    3. 查看错误日志定位问题
```

#### 更新部署时

```powershell
[2/8] 创建备份...
  ✓ 备份已保存到: .backup/20240129_143052
[3/8] 配置环境变量...
...

# 如果失败
========================================
  部署失败
  原因: 镜像构建失败
========================================

  开始回滚...

[回滚 1/3] 恢复配置文件...
  ✓ 已恢复 docker-compose.yml
  ✓ 已恢复 .env

[回滚 2/3] 清理失败的容器...
  ✓ 已清理失败的容器

[回滚 3/3] 尝试恢复旧服务...
  ✓ 已恢复旧服务

========================================
  回滚完成
========================================
```

---

## 📊 对比表格

| 特性 | 首次部署 | 更新部署 |
|------|---------|---------|
| 旧服务 | ❌ 无 | ✅ 有 |
| 备份 | ⏭️ 跳过 | ✅ 自动创建 |
| 失败后 | 🧹 清理 | ♻️ 回滚 |
| 系统状态 | 无服务 | 服务可用 |
| 操作建议 | 修复后重试 | 自动恢复 |

---

## 🚀 使用指南

### 首次部署

#### Windows
```powershell
# 首次部署（会自动检测）
.\deploy-windows-with-rollback.ps1

# 输出示例：
# [2/8] 跳过备份（首次部署）
# ...
```

#### Linux/macOS
```bash
# 首次部署（会自动检测）
./deploy-linux-with-rollback.sh

# 输出示例：
# [2/8] 跳过备份（首次部署）
# ...
```

**首次部署失败怎么办？**

1. 查看错误信息
2. 根据 `TROUBLESHOOTING.md` 解决问题
3. 重新运行部署脚本

---

### 更新部署

#### Windows
```powershell
# 更新部署（会自动备份）
.\deploy-windows-with-rollback.ps1

# 输出示例：
# [2/8] 创建备份...
#   ✓ 备份已保存到: .backup/20240129_143052
# ...
```

#### Linux/macOS
```bash
# 更新部署（会自动备份）
./deploy-linux-with-rollback.sh

# 输出示例：
# [2/8] 创建备份...
#   ✓ 备份已保存到: .backup/20240129_143052
# ...
```

**更新失败怎么办？**

- ✅ 脚本会自动回滚
- ✅ 旧服务继续运行
- ✅ 系统保持可用

---

## 🆘 常见问题

### Q1: 如何判断是否为首次部署？

**A**: 脚本会自动检测。你也可以手动检查：

```bash
# 检查是否有运行中的容器
docker compose ps

# 如果输出为空或没有 agpayplus 容器，则为首次部署
```

---

### Q2: 首次部署失败后需要手动回滚吗？

**A**: 不需要！首次部署失败只需：

1. 清理失败的资源（脚本自动完成）
2. 修复问题
3. 重新运行部署脚本

---

### Q3: 更新部署时可以跳过备份吗？

**A**: 可以，但不推荐：

```powershell
# Windows
.\deploy-windows-with-rollback.ps1 -NoBackup

# Linux/macOS
./deploy-linux-with-rollback.sh --no-backup
```

⚠️ **警告**：跳过备份后，失败时无法自动回滚！

---

### Q4: 首次部署失败后，备份目录是空的？

**A**: 正常！首次部署不会创建备份：

```bash
.backup/
  (空的，或不存在)
```

---

### Q5: 如何强制创建备份？

**A**: 脚本会自动检测，但你可以手动备份：

```bash
# 手动创建备份目录
mkdir -p .backup/manual_$(date +%Y%m%d_%H%M%S)

# 备份配置
cp docker-compose.yml .backup/manual_*/
cp .env .backup/manual_*/
```

---

## 💡 最佳实践

### 首次部署建议

1. ✅ 仔细检查 `.env` 配置
2. ✅ 确保网络畅通（配置镜像源）
3. ✅ 准备充足的磁盘空间（>10GB）
4. ✅ 首次构建较慢，耐心等待

### 更新部署建议

1. ✅ 使用带回滚的脚本
2. ✅ 不要跳过备份
3. ✅ 更新前手动备份数据库
4. ✅ 在测试环境先验证

---

## 📝 示例场景

### 场景 1：首次部署成功

```powershell
PS> .\deploy-windows-with-rollback.ps1

========================================
  AgPay+ Windows 部署脚本（带回滚）
========================================

[1/8] 检查 Docker 环境...
  ✓ Docker 版本: 24.0.7
  ✓ Docker Compose: docker compose (v2.24.0)

[2/8] 跳过备份（首次部署）  # ← 自动检测

[3/8] 配置环境变量...
  ✓ 使用现有 .env 配置

[4/8] 配置 SSL 证书...
  ✓ 使用现有证书

[5/8] 创建数据目录...
  ✓ 目录已存在: C:\agpay-data

[6/8] 停止旧容器...
  ! 没有需要停止的容器

[7/8] 构建 Docker 镜像...
  ✓ 镜像构建成功

[8/8] 启动服务...
  ✓ 所有服务启动成功

========================================
  部署成功！
========================================
```

---

### 场景 2：首次部署失败

```powershell
[7/8] 构建 Docker 镜像...
  ✗ 镜像构建失败: failed to do request

========================================
  部署失败
  原因: 镜像构建失败
========================================

[清理] 这是首次部署，清理失败的资源...  # ← 清理，不回滚
  ✓ 已清理失败的容器

  首次部署失败，请检查错误信息后重试
  提示：
    1. 检查 .env 配置是否正确
    2. 确保网络连接正常（参考 DOCKER_MIRROR_GUIDE.md）
    3. 查看错误日志定位问题
```

**解决方法**：
1. 根据提示配置 Docker 镜像源
2. 重新运行 `.\deploy-windows-with-rollback.ps1`

---

### 场景 3：更新部署成功

```bash
$ ./deploy-linux-with-rollback.sh

[1/8] 检查 Docker 环境...
  ✓ Docker 版本: 24.0.7

[2/8] 创建备份...  # ← 自动备份
  ✓ 备份已保存到: .backup/20240129_143052

[3/8] 配置环境变量...
  ✓ 使用现有 .env 配置

...

[8/8] 启动服务...
  ✓ 所有服务启动成功

========================================
  部署成功！
========================================

备份位置：.backup/20240129_143052
如需回滚，请运行：./rollback-deployment.sh .backup/20240129_143052
```

---

### 场景 4：更新部署失败（自动回滚）

```bash
[2/8] 创建备份...
  ✓ 备份已保存到: .backup/20240129_153022

[7/8] 构建 Docker 镜像...
  ✗ 镜像构建失败

========================================
  部署失败
  原因: 镜像构建失败
========================================

  开始回滚...  # ← 自动回滚

[回滚 1/3] 恢复配置文件...
  ✓ 已恢复 docker-compose.yml
  ✓ 已恢复 .env

[回滚 2/3] 清理失败的容器...
  ✓ 已清理失败的容器

[回滚 3/3] 尝试恢复旧服务...
  ✓ 已恢复旧服务

========================================
  回滚完成
========================================

# 检查服务状态
$ docker compose ps
NAME                STATUS
manager-api         Up 2 hours  # ← 旧服务继续运行
agent-api           Up 2 hours
...
```

---

## 📚 相关文档

- `DEPLOYMENT_ROLLBACK_GUIDE.md` - 完整回滚指南
- `TROUBLESHOOTING.md` - 问题排查手册
- `DOCKER_MIRROR_GUIDE.md` - 镜像源配置

---

**总结**：首次部署和更新部署是不同的场景，脚本会智能识别并采取正确的策略。你无需手动判断，只管运行脚本即可！✅
