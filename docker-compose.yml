version: '3.8'

services:
  ui-manager:
    build:
      context: ./ant-design-vue # 设置构建上下文为包含所有需要的源码的目录
      dockerfile: agpay-ui-manager/Dockerfile # 指定Dockerfile相对于新的context的路径
    image: agpay-ui-manager:latest
    ports:
      - "8817:80"  # 将宿主机的 8817 端口映射到容器的 80 端口
    environment:
      # - NODE_ENV=production
      # - VUE_APP_PREVIEW=false
      # - VUE_APP_BASE_URL=/
      - VUE_APP_API_BASE_URL=https://${IPORDOMAIN}:9817 # 更新为实际生产服务器IP或域名
    networks:
      - app-network

  ui-agent:
    build:
      context: ./ant-design-vue # 设置构建上下文为包含所有需要的源码的目录
      dockerfile: agpay-ui-agent/Dockerfile # 指定Dockerfile相对于新的context的路径
    image: agpay-ui-agent:latest
    ports:
      - "8816:80"  # 将宿主机的 8816 端口映射到容器的 80 端口
    environment:
      # - NODE_ENV=production
      # - VUE_APP_PREVIEW=false
      # - VUE_APP_BASE_URL=/
      - VUE_APP_API_BASE_URL=https://${IPORDOMAIN}:9816 # 更新为实际生产服务器IP或域名
    networks:
      - app-network

  ui-merchant:
    build:
      context: ./ant-design-vue
      dockerfile: agpay-ui-merchant/Dockerfile
    image: agpay-ui-merchant:latest
    ports:
      - "8818:80"
    environment:
      - VUE_APP_API_BASE_URL=https://${IPORDOMAIN}:9818
    networks:
      - app-network

  manager-api:
    build:
      context: ./aspnet-core/src # 设置构建上下文为包含所有需要的源码的目录
      dockerfile: AGooday.AgPay.Manager.Api/Dockerfile # 指定Dockerfile相对于新的context的路径
    image: agpay-manager-api:latest
    ports:
      - "5817:5817"
      - "9817:9817"
    environment:
      # CORS 配置
      - Cors__AllowedOrigins=https://${IPORDOMAIN}:8817,http://${IPORDOMAIN}:8817
      
      # JWT 配置
      - JWT__Issuer=https://${IPORDOMAIN}:9817
      - JWT__Audience=https://${IPORDOMAIN}:9817
      # - JWT__Secret=JWTAuthenticationHIGHsecuredPasswordVVVp1OH7Xzyr # 注意：不要在生产环境中直接暴露敏感信息

      # MQ 配置
      - MQ__Vender=${MQ_VENDER:-RabbitMQ}
      - MQ__RabbitMQ__HostName=${MQ_HOSTNAME:-rabbitmq} # 使用服务名称或主机
      - MQ__RabbitMQ__UserName=${MQ_USERNAME:-admin}
      - MQ__RabbitMQ__Password=${MQ_PASSWORD:-admin}
      - MQ__RabbitMQ__Port=${MQ_PORT:-5672}

      # 其他环境变量...
      - LANG=C.UTF-8
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - ASPNETCORE_URLS=https://+:9817;http://+:5817
      - ASPNETCORE_HTTPS_PORT=9817
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${CERT_PASSWORD:-123456}
      - ASPNETCORE_Kestrel__Certificates__Default__Path=${CERT_PATH_IN_CONTAINER:-/https/agpayplusapi.pfx}
      - ConnectionStrings__Default=server=${MYSQL_SERVER_NAME};port=${MYSQL_PORT};uid=${MYSQL_USER};pwd=${MYSQL_PASSWORD};database=${MYSQL_DATABASE}
      - Redis__Default__Connection=redis:6379,abortConnect=false,defaultDatabase=1 #1库：运营平台  #2库：代理商系统 #3库：商户系统 #4库：支付网关
      - AgSerilog__SeqUrl=${SEQ_URL:-http://seq:80}
      - AgSerilog__EnableSeq=${ENABLE_SEQ:-true}
      - AgSerilog__SeqApiKey=${SEQ_API_KEY:-}
    volumes:
      - ${DATA_PATH_HOST}/logs:/app/agpayplus/logs
      - ${DATA_PATH_HOST}/upload:/app/agpayplus/upload
      - ${CERT_PATH}:/https:ro
    depends_on:
      # 生产环境使用宿主机 MySQL，取消 db 依赖
      # db:
      #   condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network

  agent-api:
    build:
      context: ./aspnet-core/src # 设置构建上下文为包含所有需要的源码的目录
      dockerfile: AGooday.AgPay.Agent.Api/Dockerfile # 指定Dockerfile相对于新的context的路径
    image: agpay-agent-api:latest
    ports:
      - "5816:5816"
      - "9816:9816"
    environment:
      # CORS 配置
      - Cors__AllowedOrigins=https://${IPORDOMAIN}:8816,http://${IPORDOMAIN}:8816
      
      # JWT 配置
      - JWT__Issuer=https://${IPORDOMAIN}:9816
      - JWT__Audience=https://${IPORDOMAIN}:9816
      # - JWT__Secret=JWTAuthenticationHIGHsecuredPasswordVVVp1OH7Xzyr # 注意：不要在生产环境中直接暴露敏感信息

      # MQ 配置
      - MQ__Vender=${MQ_VENDER:-RabbitMQ}
      - MQ__RabbitMQ__HostName=${MQ_HOSTNAME:-rabbitmq} # 使用服务名称或主机
      - MQ__RabbitMQ__UserName=${MQ_USERNAME:-admin}
      - MQ__RabbitMQ__Password=${MQ_PASSWORD:-admin}
      - MQ__RabbitMQ__Port=${MQ_PORT:-5672}

      # 其他环境变量...
      - LANG=C.UTF-8
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - ASPNETCORE_URLS=https://+:9816;http://+:5816
      - ASPNETCORE_HTTPS_PORT=9816
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${CERT_PASSWORD:-123456}
      - ASPNETCORE_Kestrel__Certificates__Default__Path=${CERT_PATH_IN_CONTAINER:-/https/agpayplusapi.pfx}
      - ConnectionStrings__Default=server=${MYSQL_SERVER_NAME};port=${MYSQL_PORT};uid=${MYSQL_USER};pwd=${MYSQL_PASSWORD};database=${MYSQL_DATABASE}
      - Redis__Default__Connection=redis:6379,abortConnect=false,defaultDatabase=2 #1库：运营平台  #2库：代理商系统 #3库：商户系统 #4库：支付网关
      - AgSerilog__SeqUrl=${SEQ_URL:-http://seq:80}
      - AgSerilog__EnableSeq=${ENABLE_SEQ:-true}
      - AgSerilog__SeqApiKey=${SEQ_API_KEY:-}
    volumes:
      - ${DATA_PATH_HOST}/logs:/app/agpayplus/logs
      - ${DATA_PATH_HOST}/upload:/app/agpayplus/upload
      - ${CERT_PATH}:/https:ro
    depends_on:
      # 生产环境使用宿主机 MySQL，取消 db 依赖
      # db:
      #   condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network

  merchant-api:
    build:
      context: ./aspnet-core/src # 设置构建上下文为包含所有需要的源码的目录
      dockerfile: AGooday.AgPay.Merchant.Api/Dockerfile # 指定Dockerfile相对于新的context的路径
    image: agpay-merchant-api:latest
    ports:
      - "5818:5818"
      - "9818:9818"
    environment:
      # CORS 配置
      - Cors__AllowedOrigins=https://${IPORDOMAIN}:8818,http://${IPORDOMAIN}:8818
      
      # JWT 配置
      - JWT__Issuer=https://${IPORDOMAIN}:9818
      - JWT__Audience=https://${IPORDOMAIN}:9818
      # - JWT__Secret=JWTAuthenticationHIGHsecuredPasswordVVVp1OH7Xzyr # 注意：不要在生产环境中直接暴露敏感信息

      # MQ 配置
      - MQ__Vender=${MQ_VENDER:-RabbitMQ}
      - MQ__RabbitMQ__HostName=${MQ_HOSTNAME:-rabbitmq} # 使用服务名称或主机
      - MQ__RabbitMQ__UserName=${MQ_USERNAME:-admin}
      - MQ__RabbitMQ__Password=${MQ_PASSWORD:-admin}
      - MQ__RabbitMQ__Port=${MQ_PORT:-5672}

      # 其他环境变量...
      - LANG=C.UTF-8
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - ASPNETCORE_URLS=https://+:9818;http://+:5818
      - ASPNETCORE_HTTPS_PORT=9818
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${CERT_PASSWORD:-123456}
      - ASPNETCORE_Kestrel__Certificates__Default__Path=${CERT_PATH_IN_CONTAINER:-/https/agpayplusapi.pfx}
      - ConnectionStrings__Default=server=${MYSQL_SERVER_NAME};port=${MYSQL_PORT};uid=${MYSQL_USER};pwd=${MYSQL_PASSWORD};database=${MYSQL_DATABASE}
      - Redis__Default__Connection=redis:6379,abortConnect=false,defaultDatabase=3 #1库：运营平台  #2库：代理商系统 #3库：商户系统 #4库：支付网关
      - AgSerilog__SeqUrl=${SEQ_URL:-http://seq:80}
      - AgSerilog__EnableSeq=${ENABLE_SEQ:-true}
      - AgSerilog__SeqApiKey=${SEQ_API_KEY:-}
    volumes:
      - ${DATA_PATH_HOST}/logs:/app/agpayplus/logs
      - ${DATA_PATH_HOST}/upload:/app/agpayplus/upload
      - ${CERT_PATH}:/https:ro
    depends_on:
      # 生产环境使用宿主机 MySQL，取消 db 依赖
      # db:
      #   condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network

  payment-api:
    build:
      context: ./aspnet-core/src # 需要包含根目录（收银台前端在 ant-design-vue 目录）
      dockerfile: AGooday.AgPay.Payment.Api/Dockerfile # 指定Dockerfile相对于新的context的路径
    image: agpay-payment-api:latest
    ports:
      - "5819:5819"
      - "9819:9819"
    environment:
      - Cors__AllowedOrigins=https://${IPORDOMAIN}:8819,http://${IPORDOMAIN}:8819
      - MQ__Vender=${MQ_VENDER:-RabbitMQ}
      - MQ__RabbitMQ__HostName=${MQ_HOSTNAME:-rabbitmq}
      - MQ__RabbitMQ__UserName=${MQ_USERNAME:-admin}
      - MQ__RabbitMQ__Password=${MQ_PASSWORD:-admin}
      - MQ__RabbitMQ__Port=${MQ_PORT:-5672}
      - LANG=C.UTF-8
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - ASPNETCORE_URLS=https://+:9819;http://+:5819
      - ASPNETCORE_HTTPS_PORT=9819
      - ASPNETCORE_Kestrel__Certificates__Default__Password=123456
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/agpayplusapi.pfx
      - ConnectionStrings__Default=server=${MYSQL_SERVER_NAME};port=${MYSQL_PORT};uid=${MYSQL_USER};pwd=${MYSQL_PASSWORD};database=${MYSQL_DATABASE}
      - Redis__Default__Connection=redis:6379,abortConnect=false,defaultDatabase=4
      - AgSerilog__SeqUrl=${SEQ_URL:-http://seq:80}
      - AgSerilog__EnableSeq=${ENABLE_SEQ:-true}
      - AgSerilog__SeqApiKey=${SEQ_API_KEY:-}
    volumes:
      - ${DATA_PATH_HOST}/logs:/app/agpayplus/logs
      - ${DATA_PATH_HOST}/upload:/app/agpayplus/upload
      - ${CERT_PATH}:/https:ro
    depends_on:
      # 注意：生产环境应使用宿主机 MySQL，取消 db 依赖
      # db:
      #   condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - app-network

  seq:
    image: datalust/seq:latest
    environment:
      - ACCEPT_EULA=Y
    ports:
      - "5341:80"
    volumes:
      - ${DATA_PATH_HOST}/seq:/data
    networks:
      - app-network

  # ========================================
  # MySQL 数据库服务（可选 - 仅用于开发/测试）
  # ========================================
  # ⚠️ 生产环境警告：
  # 生产环境强烈建议使用宿主机 MySQL 或云数据库（RDS）
  # Docker MySQL 仅适用于开发/测试环境
  # 
  # 启用方法：
  #   1. 取消下面的 db 服务注释
  #   2. 取消所有 API 服务中的 db 依赖注释
  #   3. 修改 .env：MYSQL_SERVER_NAME=db
  # 
  # 详细说明：DATABASE_SETUP.md
  # ========================================
  # db:
  #   image: mysql:8.0
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
  #     MYSQL_DATABASE: ${MYSQL_DATABASE}
  #     MYSQL_USER: ${MYSQL_USER}
  #     MYSQL_PASSWORD: ${MYSQL_PASSWORD}
  #     TZ: Asia/Shanghai
  #   ports:
  #     - "${MYSQL_PORT}:3306"
  #   volumes:
  #     - ./aspnet-core/docs/sql/agpayplusinit.sql:/docker-entrypoint-initdb.d/init.sql:ro
  #     - ${DATA_PATH_HOST}/mysql:/var/lib/mysql
  #   command: 
  #     - --character-set-server=utf8mb4
  #     - --collation-server=utf8mb4_unicode_ci
  #     - --default-authentication-plugin=mysql_native_password
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_PASSWORD}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - app-network

  redis:
    image: redis
    ports:
      - "6379:6379" # 将宿主机的 6379 端口映射到容器的 6379 端口
    volumes:
      - ${DATA_PATH_HOST}/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  rabbitmq:
    image: rabbitmq:3-management
    hostname: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${MQ_USERNAME:-admin}
      - RABBITMQ_DEFAULT_PASS=${MQ_PASSWORD:-admin}
    ports:
      - "15672:15672"
      - "5672:5672"
    volumes:
      - ./aspnet-core/docs/rabbitmq_plugin:/plugins  # 挂载包含插件的本地目录到容器内的/plugins目录
      - ${DATA_PATH_HOST}/rabbitmq:/var/lib/rabbitmq
    command: >
      bash -c "
      cp /plugins/*.ez /opt/rabbitmq/plugins/ &&
      rabbitmq-plugins enable rabbitmq_delayed_message_exchange &&
      rabbitmq-server
      "
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

# ========================================
# Docker MySQL 数据持久化（可选）
# ========================================
# MySQL 现在使用 host bind mount 方式
# 数据将保存在 ${DATA_PATH_HOST}/mysql 目录
# 与 Redis、RabbitMQ、Seq 等服务保持一致
# 
# 优势：
#   - 统一管理：所有数据在 ${DATA_PATH_HOST} 下
#   - 便于备份：直接备份数据目录
#   - 易于迁移：复制目录即可迁移
#   - 位置透明：数据位置明确
# 
# 迁移说明：如果之前使用了 named volume，
# 请参考 MYSQL_MIGRATION.md 进行数据迁移
# ========================================