# ========================================
# AgPay+ Payment API Dockerfile
# ========================================
# å¤šé˜¶æ®µæ„å»ºï¼Œæ”¯æŒå¯é€‰çš„ cashier æ„å»º
# ========================================
# æ„å»ºå‚æ•°ï¼š
# BUILD_CASHIER=true  - æ„å»ºæ–°çš„ cashier
# BUILD_CASHIER=false - è·³è¿‡ cashier æ„å»ºï¼ˆé»˜è®¤ï¼‰
# ========================================
# ä½¿ç”¨æ–¹æ³•ï¼ˆå¿…é¡»åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼‰ï¼š
#
# æ¨èæ–¹å¼ 1ï¼šä½¿ç”¨ docker-composeï¼ˆè‡ªåŠ¨å¤„ç†è·¯å¾„ï¼‰
#   docker compose build agpay-payment-api                             # ä¸æ„å»º cashier
#   docker compose build --build-arg BUILD_CASHIER=true agpay-payment-api  # æ„å»º cashier
#
# æ¨èæ–¹å¼ 2ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬
#   .\deploy.ps1 -Environment dev                    # Windowsï¼Œä¸æ„å»º cashier
#   .\deploy.ps1 -Environment dev -BuildCashier      # Windowsï¼Œæ„å»º cashier
#   ./deploy.sh -e dev                               # Linuxï¼Œä¸æ„å»º cashier
#   ./deploy.sh -e dev -b                            # Linuxï¼Œæ„å»º cashier
#
# ç›´æ¥ä½¿ç”¨ docker buildï¼ˆéœ€æŒ‡å®š Dockerfile è·¯å¾„ï¼‰ï¼š
#   cd <é¡¹ç›®æ ¹ç›®å½•>
#   docker build -f aspnet-core/src/AGooday.AgPay.Payment.Api/Dockerfile -t agpay-payment-api .
#   docker build --build-arg BUILD_CASHIER=true -f aspnet-core/src/AGooday.AgPay.Payment.Api/Dockerfile -t agpay-payment-api .
# ========================================

# æ„å»ºå‚æ•°
ARG BUILD_CASHIER=false

# ========================================
# é˜¶æ®µ 1: æ„å»ºæ”¶é“¶å°å‰ç«¯ (Cashier) - å¯é€‰
# ========================================
FROM node:16-alpine AS cashier-builder
ARG BUILD_CASHIER
WORKDIR /cashier

# ä½¿ç”¨æ¡ä»¶å¤åˆ¶å’Œæ„å»º
# å¦‚æœ BUILD_CASHIER=falseï¼Œåˆ›å»ºç©ºç›®å½•
RUN echo "BUILD_CASHIER=$BUILD_CASHIER"

# è®¾ç½® npm é•œåƒæºå’Œè¶…æ—¶æ—¶é—´
RUN npm config set registry https://registry.npmmirror.com && \
    npm config set timeout 120000 && \
    npm config set fetch-timeout 120000 && \
    npm config set fetch-retries 3

# å¤åˆ¶ cashier package.jsonï¼ˆå¦‚æœä¸å­˜åœ¨ä¼šå¤±è´¥ï¼Œè¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼‰
COPY ant-design-vue/agpay-ui-cashier/package*.json ./

# æ¡ä»¶å®‰è£…ä¾èµ–
RUN if [ "$BUILD_CASHIER" = "true" ]; then \
        echo "ğŸ”¨ Building cashier frontend..."; \
        npm install; \
    else \
        echo "â­ï¸  Skipping cashier npm install"; \
    fi

# å¤åˆ¶ cashier æºä»£ç 
COPY ant-design-vue/agpay-ui-cashier/. .

# æ¡ä»¶æ„å»ºæˆ–åˆ›å»ºç©ºç›®å½•
RUN if [ "$BUILD_CASHIER" = "true" ]; then \
        npm run build; \
        echo "âœ… Cashier build completed"; \
    else \
        echo "â„¹ï¸  Skipping cashier build, creating empty dist"; \
        mkdir -p /cashier/dist; \
    fi

# ========================================
# é˜¶æ®µ 2: åŸºç¡€è¿è¡Œæ—¶ç¯å¢ƒ
# ========================================
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
ENV LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false \
    TZ=Asia/Shanghai

# è®¾ç½®æ—¶åŒº
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

USER app
WORKDIR /app
EXPOSE 5819
EXPOSE 9819
ENV ASPNETCORE_URLS=http://+:5819;https://+:9819

# ========================================
# é˜¶æ®µ 3: æ„å»º .NET åç«¯
# ========================================
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶ï¼ˆä»é¡¹ç›®æ ¹ç›®å½•å¼€å§‹ï¼‰
COPY aspnet-core/src/AGooday.AgPay.Payment.Api/AGooday.AgPay.Payment.Api.csproj aspnet-core/src/AGooday.AgPay.Payment.Api/
COPY aspnet-core/src/AGooday.AgPay.Application/AGooday.AgPay.Application.csproj aspnet-core/src/AGooday.AgPay.Application/
COPY aspnet-core/src/AGooday.AgPay.Base.Api/AGooday.AgPay.Base.Api.csproj aspnet-core/src/AGooday.AgPay.Base.Api/
COPY aspnet-core/src/AGooday.AgPay.Infrastructure/AGooday.AgPay.Infrastructure.csproj aspnet-core/src/AGooday.AgPay.Infrastructure/
COPY aspnet-core/src/AGooday.AgPay.Domain/AGooday.AgPay.Domain.csproj aspnet-core/src/AGooday.AgPay.Domain/
COPY aspnet-core/src/AGooday.AgPay.Common/AGooday.AgPay.Common.csproj aspnet-core/src/AGooday.AgPay.Common/
COPY aspnet-core/src/AGooday.AgPay.Components.MQ/AGooday.AgPay.Components.MQ.csproj aspnet-core/src/AGooday.AgPay.Components.MQ/
COPY aspnet-core/src/AGooday.AgPay.Domain.Core/AGooday.AgPay.Domain.Core.csproj aspnet-core/src/AGooday.AgPay.Domain.Core/
COPY aspnet-core/src/AGooday.AgPay.Logging.Serilog/AGooday.AgPay.Logging.Serilog.csproj aspnet-core/src/AGooday.AgPay.Logging.Serilog/
COPY aspnet-core/src/AGooday.AgPay.Notice.Email/AGooday.AgPay.Notice.Email.csproj aspnet-core/src/AGooday.AgPay.Notice.Email/
COPY aspnet-core/src/AGooday.AgPay.Notice.Core/AGooday.AgPay.Notice.Core.csproj aspnet-core/src/AGooday.AgPay.Notice.Core/
COPY aspnet-core/src/AGooday.AgPay.Components.Cache/AGooday.AgPay.Components.Cache.csproj aspnet-core/src/AGooday.AgPay.Components.Cache/
COPY aspnet-core/src/AGooday.AgPay.Components.OSS/AGooday.AgPay.Components.OSS.csproj aspnet-core/src/AGooday.AgPay.Components.OSS/
COPY aspnet-core/src/AGooday.AgPay.Components.SMS/AGooday.AgPay.Components.SMS.csproj aspnet-core/src/AGooday.AgPay.Components.SMS/
COPY aspnet-core/src/AGooday.AgPay.Components.Third/AGooday.AgPay.Components.Third.csproj aspnet-core/src/AGooday.AgPay.Components.Third/

# è¿˜åŸä¾èµ–
RUN dotnet restore "aspnet-core/src/AGooday.AgPay.Payment.Api/AGooday.AgPay.Payment.Api.csproj"

# å¤åˆ¶æ‰€æœ‰æºä»£ç 
COPY aspnet-core/src/. aspnet-core/src/

# æ„å»ºé¡¹ç›®
WORKDIR "/src/aspnet-core/src/AGooday.AgPay.Payment.Api"
RUN dotnet build "AGooday.AgPay.Payment.Api.csproj" -c $BUILD_CONFIGURATION -o /app/build

# ========================================
# é˜¶æ®µ 4: å‘å¸ƒ .NET åº”ç”¨
# ========================================
FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish "AGooday.AgPay.Payment.Api.csproj" -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

# ========================================
# é˜¶æ®µ 5: æœ€ç»ˆé•œåƒï¼ˆæ•´åˆåç«¯ + å‰ç«¯ï¼‰
# ========================================
FROM base AS final
ARG BUILD_CASHIER
WORKDIR /app

# åˆ›å»ºæ—¥å¿—å’Œä¸Šä¼ ç›®å½•
RUN mkdir -p /app/agpayplus/logs && \
    mkdir -p /app/agpayplus/upload && \
    chmod -R 777 /app/agpayplus/logs && \
    chmod -R 777 /app/agpayplus/upload

# å¤åˆ¶åç«¯åº”ç”¨
COPY --from=publish /app/publish .

# æ¡ä»¶å¤åˆ¶ cashier
# å¦‚æœ BUILD_CASHIER=trueï¼Œä» cashier-builder å¤åˆ¶
# å¦‚æœ BUILD_CASHIER=falseï¼Œcashier åº”è¯¥å·²ç»å­˜åœ¨äº wwwroot/cashier ä¸­
RUN if [ "$BUILD_CASHIER" = "true" ]; then \
        echo "ğŸ“¦ Copying newly built cashier"; \
    else \
        echo "ğŸ“¦ Using existing cashier from publish"; \
    fi

# å¤åˆ¶ cashierï¼ˆä»…åœ¨æ„å»ºæ—¶ï¼‰
COPY --from=cashier-builder /cashier/dist ./wwwroot/cashier

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
RUN echo "========================================" && \
    echo "AgPay+ Payment API" && \
    echo "BUILD_CASHIER: $BUILD_CASHIER" && \
    echo "========================================" && \
    ls -la ./wwwroot/cashier/ || echo "No cashier directory"

ENTRYPOINT ["dotnet", "AGooday.AgPay.Payment.Api.dll"]